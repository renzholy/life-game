<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link rel="stylesheet" href="./test.css">
  <script src="https://unpkg.com/gpu.js@2.0.0-rc.23/dist/gpu-browser.min.js"></script>
  <script type="module">

    const SIZE = 8
    const WIDTH = Math.ceil(window.innerWidth / SIZE)
    const HEIGHT = Math.ceil(window.innerHeight / SIZE)

    const array = []
    for (let i = 0; i < WIDTH * HEIGHT; i++) {
      array.push(Math.random() > 0.9 ? 1 : 0)
    }

    const gpu = new GPU()
    const prepare = gpu.createKernel(function (a) {
      return a[this.thread.y][this.thread.x]
    }).setOutput([WIDTH, HEIGHT])

    const reproduction = gpu.createKernel(function (a) {
      const around = (a[this.thread.y - 1][this.thread.x - 1])
        + (a[this.thread.y - 1][this.thread.x])
        + (a[this.thread.y - 1][this.thread.x + 1])
        + (a[this.thread.y][this.thread.x - 1])
        + (a[this.thread.y][this.thread.x + 1])
        + (a[this.thread.y + 1][this.thread.x - 1])
        + (a[this.thread.y + 1][this.thread.x])
        + (a[this.thread.y + 1][this.thread.x + 1])
      if (a[this.thread.y][this.thread.x] === 1) {
        if (around === 2 || around === 3) {
          return 1
        }
        return 0
      }
      if (around === 3) {
        return 1
      }
      return 0
    }).setOutput([WIDTH, HEIGHT])

    const diff = gpu.createKernel(function (a, b) {
      if (a[this.thread.y][this.thread.x] === b[this.thread.y][this.thread.x]) {
        return 0
      }
      if (b[this.thread.y][this.thread.x] === 1) {
        return 1
      }
      return -1
    }).setOutput([WIDTH, HEIGHT])

    function drawPoint(x, y, d) {
      if (d === 1) {
        const div = document.createElement('div')
        div.id = `${x}-${y}`
        div.className = 'cell'
        div.style.left = `${x * SIZE}px`
        div.style.top = `${y * SIZE}px`
        document.body.appendChild(div)
        return
      }
      if (d === -1) {
        const existed = document.getElementById(`${x}-${y}`)
        if (existed) {
          document.body.removeChild(existed)
        }
        return
      }
    }

    function nextGeneration(c) {
      const cc = reproduction(c)
      const d = diff(c, cc)
      for (let x = 0; x < WIDTH; x++) {
        for (let y = 0; y < HEIGHT; y++) {
          drawPoint(x, y, d[y][x])
        }
      }
      setTimeout(() => {
        nextGeneration(cc)
      }, 1000 / 60)
    }

    nextGeneration(prepare(GPU.input(array, [WIDTH, HEIGHT])))
  </script>
</head>

<body>

</body>

</html>
